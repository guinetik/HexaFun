<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InMemoryHexaRepo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
<!-- <!-- terminal-javadocs-injected [coverage] -->
<link rel="stylesheet" href="../../terminal-styles/terminaljavadocs-coverage.min.css">
<script src="../../terminal-styles/terminaljavadocs.min.js" defer></script>
</head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HexaFun Core</a> &gt; <a href="index.source.html" class="el_package">com.guinetik.hexafun.hexa</a> &gt; <span class="el_source">InMemoryHexaRepo.java</span></div><h1>InMemoryHexaRepo.java</h1><pre class="source lang-java linenums">package com.guinetik.hexafun.hexa;

import java.nio.file.DirectoryStream.Filter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

import com.guinetik.hexafun.fun.Result;

/**
 * Generic in-memory implementation of the HexaRepo interface.
 * Uses a HashMap to store entities with string IDs.
 * 
 * @param &lt;T&gt; The entity type this repository manages
 */
public class InMemoryHexaRepo&lt;T&gt; implements HexaRepo&lt;T&gt; {

<span class="pc" id="L21">    private final Map&lt;String, T&gt; storage = new HashMap&lt;&gt;();</span>
    private final Function&lt;T, String&gt; idExtractor;
    private final Function&lt;T, T&gt; idGenerator;

    /**
     * Creates a new InMemoryHexaRepo with custom ID extraction and generation.
     * 
     * @param idExtractor Function to extract ID from an entity
     * @param idGenerator Function to generate a new ID for an entity that doesn't have one
     */
<span class="fc" id="L31">    public InMemoryHexaRepo(Function&lt;T, String&gt; idExtractor, Function&lt;T, T&gt; idGenerator) {</span>
<span class="fc" id="L32">        this.idExtractor = idExtractor;</span>
<span class="fc" id="L33">        this.idGenerator = idGenerator;</span>
<span class="fc" id="L34">    }</span>

    /**
     * Creates a new InMemoryHexaRepo with default UUID generation.
     * Note: This constructor assumes the entity has an ID field named &quot;id&quot; 
     * and is accessible via reflection or a setter.
     * 
     * @param idExtractor Function to extract ID from an entity
     */
<span class="nc" id="L43">    public InMemoryHexaRepo(Function&lt;T, String&gt; idExtractor) {</span>
<span class="nc" id="L44">        this.idExtractor = idExtractor;</span>
<span class="nc" id="L45">        this.idGenerator = entity -&gt; {</span>
            // This is a placeholder. In a real implementation, 
            // you would need to set the ID on the entity.
            // This requires knowing the entity structure.
<span class="nc" id="L49">            return entity;</span>
        };
<span class="nc" id="L51">    }</span>
    
    /**
     * Creates a new InMemoryHexaRepo with default behavior.
     * The idExtractor returns the ID from storage based on the entity.
     * The idGenerator simply returns the entity as is.
     */
<span class="nc" id="L58">    public InMemoryHexaRepo() {</span>
<span class="nc" id="L59">        this.idExtractor = entity -&gt; {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            for (Map.Entry&lt;String, T&gt; entry : storage.entrySet()) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">                if (entry.getValue().equals(entity)) {</span>
<span class="nc" id="L62">                    return entry.getKey();</span>
                }
<span class="nc" id="L64">            }</span>
<span class="nc" id="L65">            return String.valueOf(storage.size() + 1);</span>
        };
<span class="nc" id="L67">        this.idGenerator = entity -&gt; entity;</span>
<span class="nc" id="L68">    }</span>

    //-------------------------------------------------------------------------
    // Create operations
    //-------------------------------------------------------------------------

    @Override
    public Result&lt;T&gt; save(T entity) {
        try {
<span class="fc" id="L77">            String id = idExtractor.apply(entity);</span>
            
            // If no ID, generate one
<span class="pc bpc" id="L80" title="1 of 4 branches missed.">            if (id == null || id.isEmpty()) {</span>
<span class="fc" id="L81">                entity = idGenerator.apply(entity);</span>
<span class="fc" id="L82">                id = idExtractor.apply(entity);</span>
            }
            
<span class="fc" id="L85">            storage.put(id, entity);</span>
<span class="fc" id="L86">            return Result.ok(entity);</span>
<span class="nc" id="L87">        } catch (Exception e) {</span>
<span class="nc" id="L88">            return Result.fail(&quot;Failed to save entity: &quot; + e.getMessage());</span>
        }
    }

    @Override
    public Result&lt;List&lt;T&gt;&gt; saveAll(List&lt;T&gt; entities) {
        try {
<span class="fc" id="L95">            List&lt;T&gt; savedEntities = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">            for (T entity : entities) {</span>
<span class="fc" id="L97">                Result&lt;T&gt; result = save(entity);</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">                if (result.isFailure()) {</span>
<span class="nc" id="L99">                    return Result.fail(&quot;Failed to save entities: &quot; + result.error());</span>
                }
<span class="fc" id="L101">                savedEntities.add(result.get());</span>
<span class="fc" id="L102">            }</span>
<span class="fc" id="L103">            return Result.ok(savedEntities);</span>
<span class="nc" id="L104">        } catch (Exception e) {</span>
<span class="nc" id="L105">            return Result.fail(&quot;Failed to save entities: &quot; + e.getMessage());</span>
        }
    }

    //-------------------------------------------------------------------------
    // Read operations
    //-------------------------------------------------------------------------

    @Override
    public Result&lt;T&gt; findById(String id) {
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">        if (id == null || id.isEmpty()) {</span>
<span class="nc" id="L116">            return Result.fail(&quot;ID cannot be null or empty&quot;);</span>
        }
        
<span class="fc" id="L119">        T entity = storage.get(id);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (entity == null) {</span>
<span class="fc" id="L121">            return Result.fail(&quot;Entity not found with ID: &quot; + id);</span>
        }
        
<span class="fc" id="L124">        return Result.ok(entity);</span>
    }

    @Override
    public Result&lt;List&lt;T&gt;&gt; findAll() {
<span class="fc" id="L129">        return Result.ok(new ArrayList&lt;&gt;(storage.values()));</span>
    }

    @Override
    public Result&lt;List&lt;T&gt;&gt; findBy(Filter&lt;T&gt; filter) {
        try {
            // Since DirectoryStream.Filter only has an accept method,
            // we need to create our own filtering logic
<span class="fc" id="L137">            List&lt;T&gt; result = storage.values().stream()</span>
<span class="fc" id="L138">                .filter(entity -&gt; {</span>
                    try {
<span class="fc" id="L140">                        return filter.accept(entity);</span>
<span class="nc" id="L141">                    } catch (Exception e) {</span>
<span class="nc" id="L142">                        return false;</span>
                    }
                })
<span class="fc" id="L145">                .collect(Collectors.toList());</span>
            
<span class="fc" id="L147">            return Result.ok(result);</span>
<span class="nc" id="L148">        } catch (Exception e) {</span>
<span class="nc" id="L149">            return Result.fail(&quot;Failed to filter entities: &quot; + e.getMessage());</span>
        }
    }

    @Override
    public Result&lt;List&lt;T&gt;&gt; findAll(int offset, int limit) {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (offset &lt; 0) {</span>
<span class="nc" id="L156">            return Result.fail(&quot;Offset cannot be negative&quot;);</span>
        }
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">        if (limit &lt; 0) {</span>
<span class="nc" id="L159">            return Result.fail(&quot;Limit cannot be negative&quot;);</span>
        }
        
<span class="fc" id="L162">        List&lt;T&gt; allEntities = new ArrayList&lt;&gt;(storage.values());</span>
<span class="fc" id="L163">        int fromIndex = Math.min(offset, allEntities.size());</span>
<span class="fc" id="L164">        int toIndex = Math.min(offset + limit, allEntities.size());</span>
        
<span class="fc" id="L166">        return Result.ok(allEntities.subList(fromIndex, toIndex));</span>
    }

    @Override
    public Result&lt;Long&gt; count() {
<span class="fc" id="L171">        return Result.ok((long) storage.size());</span>
    }

    //-------------------------------------------------------------------------
    // Update operations
    //-------------------------------------------------------------------------

    @Override
    public Result&lt;T&gt; update(String id, T entity) {
<span class="pc bpc" id="L180" title="2 of 4 branches missed.">        if (id == null || id.isEmpty()) {</span>
<span class="nc" id="L181">            return Result.fail(&quot;ID cannot be null or empty&quot;);</span>
        }
        
<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (!storage.containsKey(id)) {</span>
<span class="fc" id="L185">            return Result.fail(&quot;Cannot update: Entity not found with ID: &quot; + id);</span>
        }
        
        try {
            // Ensure the entity has the correct ID
<span class="fc" id="L190">            String entityId = idExtractor.apply(entity);</span>
<span class="pc bpc" id="L191" title="2 of 4 branches missed.">            if (entityId == null || !entityId.equals(id)) {</span>
<span class="nc" id="L192">                return Result.fail(&quot;Entity ID doesn't match the provided ID&quot;);</span>
            }
            
<span class="fc" id="L195">            storage.put(id, entity);</span>
<span class="fc" id="L196">            return Result.ok(entity);</span>
<span class="nc" id="L197">        } catch (Exception e) {</span>
<span class="nc" id="L198">            return Result.fail(&quot;Failed to update entity: &quot; + e.getMessage());</span>
        }
    }

    //-------------------------------------------------------------------------
    // Delete operations
    //-------------------------------------------------------------------------

    @Override
    public Result&lt;Boolean&gt; deleteById(String id) {
<span class="pc bpc" id="L208" title="2 of 4 branches missed.">        if (id == null || id.isEmpty()) {</span>
<span class="nc" id="L209">            return Result.fail(&quot;ID cannot be null or empty&quot;);</span>
        }
        
<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (!storage.containsKey(id)) {</span>
<span class="fc" id="L213">            return Result.ok(false); // Entity doesn't exist, so technically delete succeeded</span>
        }
        
<span class="fc" id="L216">        storage.remove(id);</span>
<span class="fc" id="L217">        return Result.ok(true);</span>
    }

    @Override
    public Result&lt;Void&gt; deleteAllById(List&lt;String&gt; ids) {
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L223">            return Result.fail(&quot;IDs list cannot be null&quot;);</span>
        }
        
<span class="fc bfc" id="L226" title="All 2 branches covered.">        for (String id : ids) {</span>
<span class="pc bpc" id="L227" title="2 of 4 branches missed.">            if (id != null &amp;&amp; !id.isEmpty()) {</span>
<span class="fc" id="L228">                storage.remove(id);</span>
            }
<span class="fc" id="L230">        }</span>
        
<span class="fc" id="L232">        return Result.ok(null);</span>
    }

    @Override
    public Result&lt;Void&gt; clear() {
<span class="fc" id="L237">        storage.clear();</span>
<span class="fc" id="L238">        return Result.ok(null);</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>