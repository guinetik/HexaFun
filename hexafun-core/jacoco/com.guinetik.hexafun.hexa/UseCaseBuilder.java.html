<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UseCaseBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
<!-- <!-- terminal-javadocs-injected [coverage] -->
<link rel="stylesheet" href="../../terminal-styles/terminaljavadocs-coverage.min.css">
<script src="../../terminal-styles/terminaljavadocs.min.js" defer></script>
</head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HexaFun Core</a> &gt; <a href="index.source.html" class="el_package">com.guinetik.hexafun.hexa</a> &gt; <span class="el_source">UseCaseBuilder.java</span></div><h1>UseCaseBuilder.java</h1><pre class="source lang-java linenums">package com.guinetik.hexafun.hexa;

import com.guinetik.hexafun.HexaApp;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

/**
 * Builder for creating HexaApp instances with use cases, ports, and adapters.
 *
 * &lt;p&gt;Supports fluent DSL with implicit closure - each useCase() call
 * automatically closes the previous one.
 *
 * &lt;p&gt;Example:
 * &lt;pre class=&quot;language-java&quot;&gt;{@code
 * HexaFun.dsl()
 *     .withPort(TaskRepository.class, new InMemoryTaskRepository())
 *     .withAdapter(TO_DTO, task -&gt; new TaskDTO(task.id(), task.title()))
 *     .useCase(Keys.CREATE)
 *         .validate(validator)
 *         .handle(handler)
 *     .useCase(Keys.DELETE)
 *         .handle(deleteHandler)
 *     .build();
 * }&lt;/pre&gt;
 */
<span class="fc" id="L27">public class UseCaseBuilder {</span>

<span class="fc" id="L29">    private final Map&lt;String, UseCase&lt;?, ?&gt;&gt; useCases = new HashMap&lt;&gt;();</span>
<span class="fc" id="L30">    private final Map&lt;Class&lt;?&gt;, Object&gt; ports = new HashMap&lt;&gt;();</span>
<span class="fc" id="L31">    private final Map&lt;String, Function&lt;?, ?&gt;&gt; adapters = new HashMap&lt;&gt;();</span>

    // Pending registration - committed on next useCase() or build()
    private String pendingName;
    private UseCase&lt;?, ?&gt; pendingUseCase;

    /**
     * Register a port (output adapter) by its type.
     * Ports are registered when build() is called.
     *
     * &lt;p&gt;Example:
     * &lt;pre class=&quot;language-java&quot;&gt;{@code
     * HexaFun.dsl()
     *     .withPort(TaskRepository.class, new InMemoryTaskRepository())
     *     .withPort(EmailService.class, new SmtpEmailService())
     *     .useCase(...)
     *     .build();
     * }&lt;/pre&gt;
     *
     * @param type The interface/class type to register
     * @param impl The implementation instance
     * @param &lt;T&gt; The port type
     * @return This builder for chaining
     */
    public &lt;T&gt; UseCaseBuilder withPort(Class&lt;T&gt; type, T impl) {
<span class="fc" id="L56">        ports.put(type, impl);</span>
<span class="fc" id="L57">        return this;</span>
    }

    /**
     * Register an adapter with a type-safe key.
     * Adapters transform data from one type to another.
     *
     * &lt;p&gt;Example:
     * &lt;pre class=&quot;language-java&quot;&gt;{@code
     * HexaFun.dsl()
     *     .withAdapter(TO_INVENTORY, req -&gt; new InventoryCheck(req.itemId()))
     *     .withAdapter(TO_PAYMENT, req -&gt; new PaymentRequest(req.total()))
     *     .useCase(...)
     *     .build();
     * }&lt;/pre&gt;
     *
     * @param key The type-safe adapter key
     * @param adapter The transformation function
     * @param &lt;From&gt; The source type
     * @param &lt;To&gt; The target type
     * @return This builder for chaining
     */
    public &lt;From, To&gt; UseCaseBuilder withAdapter(
        AdapterKey&lt;From, To&gt; key,
        Function&lt;From, To&gt; adapter
    ) {
<span class="fc" id="L83">        adapters.put(key.name(), adapter);</span>
<span class="fc" id="L84">        return this;</span>
    }

    /**
     * Start defining a use case with a type-safe key.
     * Implicitly closes any previous use case definition.
     *
     * @param key The type-safe key for this use case
     * @param &lt;I&gt; The input type of the use case
     * @param &lt;O&gt; The output type of the use case
     * @return A new UseCaseInputStep for chaining
     */
    public &lt;I, O&gt; UseCaseInputStep&lt;I, O&gt; useCase(UseCaseKey&lt;I, O&gt; key) {
<span class="fc" id="L97">        commitPending();</span>
<span class="fc" id="L98">        return new UseCaseInputStep&lt;&gt;(key.name(), this);</span>
    }

    /**
     * Stage a use case for registration. Will be committed on next useCase() or build().
     */
    &lt;I, O&gt; void stage(String name, UseCase&lt;I, O&gt; useCase) {
<span class="fc" id="L105">        commitPending();</span>
<span class="fc" id="L106">        this.pendingName = name;</span>
<span class="fc" id="L107">        this.pendingUseCase = useCase;</span>
<span class="fc" id="L108">    }</span>

    /**
     * Commit pending use case to the registry.
     */
    private void commitPending() {
<span class="pc bpc" id="L114" title="1 of 4 branches missed.">        if (pendingName != null &amp;&amp; pendingUseCase != null) {</span>
<span class="fc" id="L115">            useCases.put(pendingName, pendingUseCase);</span>
<span class="fc" id="L116">            pendingName = null;</span>
<span class="fc" id="L117">            pendingUseCase = null;</span>
        }
<span class="fc" id="L119">    }</span>

    /**
     * Build a HexaApp with all the registered use cases and ports.
     * @return A new HexaApp instance
     */
    public HexaApp build() {
<span class="fc" id="L126">        commitPending();</span>

<span class="fc" id="L128">        HexaApp app = HexaApp.create();</span>

        // Register ports
<span class="fc bfc" id="L131" title="All 2 branches covered.">        for (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : ports.entrySet()) {</span>
<span class="fc" id="L132">            registerPort(app, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L133">        }</span>

        // Register adapters
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (Map.Entry&lt;String, Function&lt;?, ?&gt;&gt; entry : adapters.entrySet()) {</span>
<span class="fc" id="L137">            registerAdapter(app, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L138">        }</span>

        // Register use cases
<span class="fc bfc" id="L141" title="All 2 branches covered.">        for (Map.Entry&lt;String, UseCase&lt;?, ?&gt;&gt; entry : useCases.entrySet()) {</span>
<span class="fc" id="L142">            registerUseCase(app, entry.getKey(), entry.getValue());</span>
<span class="fc" id="L143">        }</span>

<span class="fc" id="L145">        return app;</span>
    }

    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    private void registerPort(HexaApp app, Class type, Object impl) {
<span class="fc" id="L150">        app.port(type, impl);</span>
<span class="fc" id="L151">    }</span>

    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    private void registerAdapter(HexaApp app, String name, Function adapter) {
<span class="fc" id="L155">        app.withAdapter(name, adapter);</span>
<span class="fc" id="L156">    }</span>

    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    private void registerUseCase(HexaApp app, String name, UseCase useCase) {
<span class="fc" id="L160">        app.withUseCase(name, useCase);</span>
<span class="fc" id="L161">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>